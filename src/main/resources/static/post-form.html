<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>글쓰기 - OFF THE RECORD</title>
    <link rel="stylesheet" href="/css/style.css?v=7">
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                OFF THE RECORD
            </a>
            <div class="nav">
                <a href="/" class="btn btn-secondary">목록으로</a>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="form-container" style="margin: 50px auto;">
            <h1 class="form-title" id="formTitle">게시글 작성</h1>
            <form id="postForm">
                <div class="form-group">
                    <label class="form-label" for="title">제목</label>
                    <input type="text" id="title" class="form-input" placeholder="제목을 입력하세요 (최대 100자)" required
                        maxlength="100">
                </div>

                <div class="form-group">
                    <label class="form-label" for="content">내용</label>
                    <textarea id="content" class="form-textarea" placeholder="내용을 입력하세요" required
                        style="min-height: 300px;"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">이미지 첨부 (최대 3장)</label>
                    <div class="image-upload-wrapper">
                        <label for="images" class="custom-file-upload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>클릭하여 사진 선택 (최대 3장)</span>
                        </label>
                        <input type="file" id="images" accept="image/*" multiple onchange="handleImageSelect(this)">
                        <div id="imagePreviewContainer" class="multi-image-preview-container">
                            <!-- Previews will be added here -->
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 16px;">
                    <button type="submit" class="btn btn-green" style="flex: 1;">
                        저장
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="history.back()">
                        취소
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        const boardId = urlParams.get('boardId') || 'free';
        const DRAFT_TITLE_KEY = 'post_draft_title';
        const DRAFT_CONTENT_KEY = 'post_draft_content';
        let isEditMode = false;
        let selectedFiles = []; // Array to store New Selected File objects
        let preservedImages = []; // Array to store Existing image URLs to keep

        function handleImageSelect(input) {
            const files = Array.from(input.files);

            // Limit to 3 images total (existing + new)
            const availableSlots = 3 - (selectedFiles.length + preservedImages.length);
            const newFiles = files.slice(0, Math.max(0, availableSlots));

            newFiles.forEach(file => {
                selectedFiles.push(file);
                renderNewFilePreview(file);
            });

            // Reset input so same file can be selected again if removed
            input.value = '';
        }

        function renderNewFilePreview(file) {
            const container = document.getElementById('imagePreviewContainer');
            const reader = new FileReader();

            reader.onload = function (e) {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.dataset.id = `file-${file.name}-${file.lastModified}`;

                previewItem.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <button type="button" class="remove-btn" onclick="removeNewFile('${file.name}', ${file.lastModified})">✕</button>
                `;
                container.appendChild(previewItem);
            }
            reader.readAsDataURL(file);
        }

        function renderExistingImagePreview(url) {
            const container = document.getElementById('imagePreviewContainer');
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.dataset.url = url;

            previewItem.innerHTML = `
                <img src="${url}" alt="Existing">
                <button type="button" class="remove-btn" onclick="removeExistingImage('${url}')">✕</button>
            `;
            container.appendChild(previewItem);
        }

        function removeNewFile(name, lastModified) {
            selectedFiles = selectedFiles.filter(f => f.name !== name || f.lastModified !== lastModified);
            const id = `file-${name}-${lastModified}`;
            const item = document.querySelector(`.preview-item[data-id="${id}"]`);
            if (item) item.remove();
        }

        function removeExistingImage(url) {
            preservedImages = preservedImages.filter(u => u !== url);
            const item = document.querySelector(`.preview-item[data-url="${url}"]`);
            if (item) item.remove();
        }

        async function init() {
            // Check authentication
            const user = await getCurrentUser();
            if (!user) {
                window.location.href = '/login.html';
                return;
            }

            // If editing, load post data
            if (postId) {
                isEditMode = true;
                document.getElementById('formTitle').textContent = '게시글 수정';
                await loadPost();
            } else {
                // New post: Set title based on boardId
                let boardName = '자유게시판';
                let placeholderText = '자유롭게 이야기를 나누어 보세요. (욕설 및 비방 금지)';

                if (boardId === 'anonymous') {
                    boardName = 'BLIND';
                    placeholderText = "이 게시판은 블라인드 형식의 게시판 입니다.\n\n" +
                        "촬영장 안팎의 부조리를 고발하는 목적입니다.\n\n" +
                        "본인이 설정한 닉네임이 아닌 게시물 단위로 랜덤한 닉네임을 배정받아 익명으로 사용할 수 있는 게시판입니다.\n" +
                        "근거없는 비방 욕설은 삼가해주세요";
                }
                else if (boardId === 'jobs') {
                    boardName = '구인구직';
                    placeholderText = "구인/구직 내용을 상세히 작성해주세요.\n예) 업무 내용, 자격 요건, 근무 조건 등";
                }

                document.getElementById('formTitle').textContent = `${boardName} 글쓰기`;
                document.getElementById('content').placeholder = placeholderText;

                // Restore draft if available
                const savedTitle = localStorage.getItem(DRAFT_TITLE_KEY);
                const savedContent = localStorage.getItem(DRAFT_CONTENT_KEY);

                if (savedTitle || savedContent) {
                    if (savedTitle) document.getElementById('title').value = savedTitle;
                    if (savedContent) document.getElementById('content').value = savedContent;
                    // Optional: Simple toast or log could go here, but keeping it silent for smooth UX
                }
            }

            // Auto-save listeners
            document.getElementById('title').addEventListener('input', (e) => {
                if (!isEditMode) localStorage.setItem(DRAFT_TITLE_KEY, e.target.value);
            });

            document.getElementById('content').addEventListener('input', (e) => {
                if (!isEditMode) localStorage.setItem(DRAFT_CONTENT_KEY, e.target.value);
            });
        }

        async function loadPost() {
            const post = await getPost(postId);
            if (post) {
                document.getElementById('title').value = post.title;
                document.getElementById('content').value = post.content;

                // Load existing images
                if (post.imageUrl) { preservedImages.push(post.imageUrl); renderExistingImagePreview(post.imageUrl); }
                if (post.imageUrl2) { preservedImages.push(post.imageUrl2); renderExistingImagePreview(post.imageUrl2); }
                if (post.imageUrl3) { preservedImages.push(post.imageUrl3); renderExistingImagePreview(post.imageUrl3); }
            }
        }

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;

            try {
                if (isEditMode) {
                    await updatePostCustom(postId, title, content, preservedImages, selectedFiles);
                    showSuccess('게시글이 수정되었습니다');
                    window.location.replace(`/post-detail.html?id=${postId}`);
                } else {
                    const result = await createPostCustom(title, content, '', selectedFiles, boardId);

                    // Clear draft on success
                    localStorage.removeItem(DRAFT_TITLE_KEY);
                    localStorage.removeItem(DRAFT_CONTENT_KEY);

                    showSuccess('게시글이 작성되었습니다');
                    window.location.replace(`/post-detail.html?id=${result.id}`);
                }
            } catch (error) {
                showError('게시글 저장에 실패했습니다');
            }
        });

        async function createPostCustom(title, content, password, files, boardId) {
            const formData = new FormData();
            formData.append('post', new Blob([JSON.stringify({ title, content, password, boardId })], {
                type: 'application/json'
            }));

            files.forEach(file => {
                formData.append('images', file);
            });

            const token = localStorage.getItem('token');
            const response = await fetch('/api/posts', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            if (!response.ok) throw new Error('Create failed');
            return response.json();
        }

        async function updatePostCustom(id, title, content, preservedImages, newFiles) {
            const formData = new FormData();
            formData.append('post', new Blob([JSON.stringify({
                title,
                content,
                preservedImages: preservedImages
            })], {
                type: 'application/json'
            }));

            newFiles.forEach(file => {
                formData.append('images', file);
            });

            const token = localStorage.getItem('token');
            const response = await fetch(`/api/posts/${id}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            if (!response.ok) throw new Error('Update failed');
            return response.json();
        }

        init();
    </script>
</body>

</html>