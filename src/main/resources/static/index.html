<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFF THE RECORD</title>
    <link rel="stylesheet" href="/css/style.css?v=7">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                OFF THE RECORD
            </a>
            <div class="nav">
                <span id="userInfo" class="user-info"></span>
                <button id="loginBtn" class="btn-cool btn-cool-compact hidden" onclick="location.href='/login.html'"
                    aria-label="로그인">
                    <i class="fas fa-sign-in-alt"></i> LOGIN
                </button>
                <button id="logoutBtn" class="btn btn-secondary btn-compact hidden" aria-label="로그아웃">
                    <i class="fas fa-lock-open"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Board Tabs -->
        <div class="board-tabs">
            <button class="board-tab active" onclick="switchBoard('free')">자유게시판</button>
            <button class="board-tab" onclick="switchBoard('anonymous')">BLIND</button>
            <button class="board-tab" onclick="switchBoard('jobs')">구인구직</button>
        </div>

        <!-- Random Best Post Section (Moved below tabs) -->
        <div id="randomBestSection" class="random-best-container hidden">
            <div id="randomBestContent"></div>
        </div>

        <div id="postsContainer" class="mobile-post-list">
            <div class="loading">게시글을 불러오는 중...</div>
        </div>

        <div id="emptyState" class="empty-state hidden">
            <h2>검색 결과가 없습니다</h2>
            <p>다른 검색어로 시도해보세요</p>
        </div>

        <div id="pagination" class="pagination hidden"></div>

        <!-- Search Toggle Button -->
        <button id="searchToggleBtn" class="search-toggle-btn" aria-label="검색">
            <div class="css-search-icon"></div>
        </button>

        <!-- 검색 영역 (기본 숨김) -->
        <div id="searchContainer" class="search-container-bottom hidden">
            <div class="search-header">
                <h3>검색</h3>
                <button id="closeSearchBtn" class="close-search-btn">✕</button>
            </div>
            <select id="searchType" class="search-select">
                <option value="title_content">제목+내용</option>
                <option value="title">제목</option>
                <option value="content">내용</option>
                <option value="author">작성자</option>
            </select>
            <input type="text" id="searchKeyword" class="search-input" placeholder="검색어를 입력하세요" />
            <div class="search-buttons">
                <button id="searchBtn" class="btn btn-primary">검색</button>
                <button id="resetBtn" class="btn btn-secondary">전체보기</button>
            </div>
        </div>
    </div>
    </div>
    </div>

    <!-- Floating Write Button -->
    <button class="floating-write-btn" onclick="openBoardModal()" aria-label="글쓰기">
        <i class="fas fa-edit"></i>
    </button>

    <script src="/js/app.js"></script>
    <script>
        let currentUser = null;
        let currentPage = 0;
        let currentBoardId = 'free';
        let currentSearchType = '';
        let currentKeyword = '';
        const pageSize = 15;

        async function init() {
            // Check authentication
            currentUser = await getCurrentUser();

            const userInfo = document.getElementById('userInfo');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            if (currentUser) {
                // Logged in
                if (currentUser.role === 'ADMIN') {
                    userInfo.innerHTML = `<span class="admin-nickname-container"><i class="fas fa-camera"></i> ${escapeHtml(currentUser.nickname)}</span>`;
                } else {
                    userInfo.textContent = currentUser.nickname;
                }
                logoutBtn.classList.remove('hidden');
                loginBtn.classList.add('hidden');
            } else {
                // Guest
                userInfo.textContent = '';
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }

            // Load posts
            await loadPosts(0);

            // Load random best post
            await loadRandomBestPost();

            // Setup search toggle
            document.getElementById('searchToggleBtn').addEventListener('click', toggleSearch);
            document.getElementById('closeSearchBtn').addEventListener('click', closeSearch);

            // Setup search
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('searchKeyword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            document.getElementById('resetBtn').addEventListener('click', resetSearch);
        }

        function toggleSearch() {
            const searchContainer = document.getElementById('searchContainer');
            const toggleBtn = document.getElementById('searchToggleBtn');

            if (searchContainer.classList.contains('hidden')) {
                searchContainer.classList.remove('hidden');
                toggleBtn.classList.add('active');
            } else {
                searchContainer.classList.add('hidden');
                toggleBtn.classList.remove('active');
            }
        }

        function closeSearch() {
            document.getElementById('searchContainer').classList.add('hidden');
            document.getElementById('searchToggleBtn').classList.remove('active');
        }

        async function switchBoard(boardId) {
            currentBoardId = boardId;
            currentPage = 0;
            currentKeyword = '';

            // Update UI
            document.querySelectorAll('.board-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.innerText.includes(boardId === 'free' ? '자유' : (boardId === 'anonymous' ? 'BLIND' : '구인'))) {
                    tab.classList.add('active');
                }
            });

            await Promise.all([
                loadPosts(0),
                loadRandomBestPost()
            ]);
        }

        async function performSearch() {
            const searchType = document.getElementById('searchType').value;
            const keyword = document.getElementById('searchKeyword').value.trim();

            if (!keyword) {
                showError('검색어를 입력하세요');
                return;
            }

            currentSearchType = searchType;
            currentKeyword = keyword;
            closeSearch();
            await loadPosts(0);
        }

        async function resetSearch() {
            currentSearchType = '';
            currentKeyword = '';
            document.getElementById('searchKeyword').value = '';
            document.getElementById('searchType').value = 'title_content';
            closeSearch();
            await loadPosts(0);
        }

        async function loadPosts(page) {
            const container = document.getElementById('postsContainer');
            const emptyState = document.getElementById('emptyState');
            const pagination = document.getElementById('pagination');

            try {
                let url;
                if (currentKeyword) {
                    url = `/api/posts/search?boardId=${currentBoardId}&searchType=${currentSearchType}&keyword=${encodeURIComponent(currentKeyword)}&page=${page}&size=${pageSize}`;
                } else {
                    url = `/api/posts?boardId=${currentBoardId}&page=${page}&size=${pageSize}`;
                }

                const response = await fetch(url, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('LoadPosts response data:', data);

                if (!data || !Array.isArray(data.posts)) {
                    console.error('Invalid data structure:', data);
                    container.innerHTML = '<div class="empty-state">데이터를 불러올 수 없습니다.</div>';
                    return;
                }

                if (data.posts.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    pagination.classList.add('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                currentPage = data.currentPage;

                // Render posts as mobile cards
                container.innerHTML = data.posts.map(post => {
                    try {
                        return createMobilePostCard(post);
                    } catch (e) {
                        console.error('Error creating post card:', post, e);
                        return '';
                    }
                }).join('');

                // Render pagination
                renderPagination(data.currentPage, data.totalPages);
            } catch (error) {
                console.error('Error loading posts:', error);
                // showError('게시글을 불러오는 중 오류가 발생했습니다'); 
                container.innerHTML = `<div class="empty-state">오류 발생: ${error.message}</div>`;
            }
        }

        function createMobilePostCard(post) {
            const date = new Date(post.createdAt);
            const timeString = formatTimeAgo(date); // Use time ago for list view

            // Check if visited
            const visitedPosts = JSON.parse(localStorage.getItem('visited_posts') || '[]');
            const isVisited = visitedPosts.includes(post.id);

            // Thumbnail Logic: Use image if exists, otherwise "No Image" text
            let thumbnailHtml;
            if (post.imageUrl) {
                thumbnailHtml = `<img src="${post.imageUrl}" alt="thumbnail" loading="lazy">`;
            } else {
                thumbnailHtml = `<div class="post-thumbnail-placeholder"><span>No</span><span>Image</span></div>`;
            }

            return `
                <div class="mobile-post-card ${isVisited ? 'visited' : ''}" onclick="markPostAsVisited(${post.id})">
                    <div class="post-thumbnail-area">
                        ${thumbnailHtml}
                    </div>
                    
                    <div class="post-content-area">
                        <div class="mobile-post-header">
                            <h3 class="mobile-post-title">
                                ${isNewPost(date) ? '<span class="new-badge"></span>' : ''}
                                ${post.title}
                            </h3>
                        </div>
                        
                        <div class="mobile-post-footer">
                            <div class="post-meta-left">
                                ${post.authorRole === 'ADMIN' ?
                    `<span class="admin-nickname-container"><i class="fas fa-camera"></i> ${escapeHtml(post.authorAnonymousNickname || post.authorNickname)}</span>` :
                    `<span class="user-nickname-badge"><i class="fas fa-user"></i> ${escapeHtml(post.authorAnonymousNickname || post.authorNickname || '익명')}</span>`
                }
                                <span>${timeString}</span>
                            </div>
                            <div class="post-meta-right">
                                <span><i class="fas fa-thumbs-up"></i> ${formatNumber(post.likeCount || 0)}</span>
                                <span><i class="fas fa-thumbs-down"></i> ${formatNumber(post.dislikeCount || 0)}</span>
                                <span><i class="fas fa-eye"></i> ${formatNumber(post.viewCount || 0)}</span>
                                <span><i class="fas fa-comment-dots"></i> ${formatNumber(post.commentCount || 0)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.classList.add('hidden');
                return;
            }

            pagination.classList.remove('hidden');

            const maxButtons = 5;
            let startPage = Math.max(0, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages - 1, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(0, endPage - maxButtons + 1);
            }

            let html = '';

            // Previous button
            if (currentPage > 0) {
                html += `<button class="page-btn" onclick="loadPosts(${currentPage - 1})">이전</button>`;
            }

            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentPage ? 'active' : '';
                html += `<button class="page-btn ${active}" onclick="loadPosts(${i})">${i + 1}</button>`;
            }

            // Next button
            if (currentPage < totalPages - 1) {
                html += `<button class="page-btn" onclick="loadPosts(${currentPage + 1})">다음</button>`;
            }

            pagination.innerHTML = html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }


        function markPostAsVisited(postId) {
            const visitedPosts = JSON.parse(localStorage.getItem('visited_posts') || '[]');
            if (!visitedPosts.includes(postId)) {
                visitedPosts.push(postId);
                // Keep only last 100 visited posts to save space
                if (visitedPosts.length > 100) visitedPosts.shift();
                localStorage.setItem('visited_posts', JSON.stringify(visitedPosts));
            }
            location.href = `/post-detail.html?id=${postId}`;
        }


        async function loadRandomBestPost() {
            const section = document.getElementById('randomBestSection');

            // 'jobs' board does not show best posts
            if (currentBoardId === 'jobs') {
                section.classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`/api/best/random?boardId=${currentBoardId}`, {
                    credentials: 'include'
                });

                if (response.status === 204) {
                    document.getElementById('randomBestSection').classList.add('hidden');
                    return;
                }

                if (!response.ok) {
                    document.getElementById('randomBestSection').classList.add('hidden');
                    return;
                }

                const post = await response.json();
                const section = document.getElementById('randomBestSection');
                const content = document.getElementById('randomBestContent');

                section.classList.remove('hidden');

                const date = new Date(post.createdAt);
                const timeString = formatTimeAgo(date);
                const displayNickname = post.authorAnonymousNickname || post.authorNickname || '익명';

                // Replicate createMobilePostCard structure for consistency
                let thumbnailHtml;
                if (post.imageUrl) {
                    thumbnailHtml = `<img src="${post.imageUrl}" alt="thumbnail" loading="lazy">`;
                } else {
                    thumbnailHtml = `<div class="post-thumbnail-placeholder"><span>No</span><span>Image</span></div>`;
                }

                // Check if visited
                const visitedPosts = JSON.parse(localStorage.getItem('visited_posts') || '[]');
                const isVisited = visitedPosts.includes(post.id);

                content.innerHTML = `
                    <div class="mobile-post-card best-post-card ${isVisited ? 'visited' : ''}" onclick="markPostAsVisited(${post.id})">
                        <button class="best-refresh-btn" onclick="event.stopPropagation(); loadRandomBestPost()" aria-label="새로고침">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        
                        <div class="post-thumbnail-area">
                            <span class="best-text-badge">BEST</span>
                            ${thumbnailHtml}
                        </div>
                        
                        <div class="post-content-area">
                            <div class="mobile-post-header">
                                <h3 class="mobile-post-title">
                                    ${post.title}
                                </h3>
                            </div>
                            
                            <div class="mobile-post-footer">
                                <div class="post-meta-left">
                                    ${post.authorRole === 'ADMIN' ?
                        `<span class="admin-nickname-container"><i class="fas fa-camera"></i> ${escapeHtml(displayNickname)}</span>` :
                        `<span class="user-nickname-badge"><i class="fas fa-user"></i> ${escapeHtml(displayNickname)}</span>`
                    }
                                    <span>${timeString}</span>
                                </div>
                                <div class="post-meta-right">
                                    <span><i class="fas fa-thumbs-up"></i> ${formatNumber(post.likeCount || 0)}</span>
                                    <span><i class="fas fa-thumbs-down"></i> ${formatNumber(post.dislikeCount || 0)}</span>
                                    <span><i class="fas fa-eye"></i> ${formatNumber(post.viewCount || 0)}</span>
                                    <span><i class="fas fa-comment-dots"></i> ${formatNumber(post.commentCount || 0)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading random best post:', error);
                document.getElementById('randomBestSection').classList.add('hidden');
            }
        }

        // Board Selection Modal Logic
        function openBoardModal() {
            if (!currentUser) {
                alert('로그인이 필요한 서비스입니다.');
                location.href = '/login.html';
                return;
            }
            const modal = document.getElementById('boardSelectModal');
            modal.classList.remove('hidden');
            // Small delay to allow display:flex to apply before opacity transition
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        function closeBoardModal() {
            const modal = document.getElementById('boardSelectModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                modal.classList.add('hidden');
            }, 300);
        }

        function selectBoardAndWrite(boardId) {
            location.href = `/post-form.html?boardId=${boardId}`;
        }

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('boardSelectModal').addEventListener('click', (e) => {
                if (e.target.id === 'boardSelectModal') {
                    closeBoardModal();
                }
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', logout);
        init();
    </script>
    <div id="boardSelectModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">게시판 선택</h3>
            <div class="board-select-buttons">
                <button class="btn-board-select" onclick="selectBoardAndWrite('free')">
                    <i class="fas fa-comment-alt"></i> 자유게시판
                </button>
                <button class="btn-board-select" onclick="selectBoardAndWrite('anonymous')">
                    <i class="fas fa-user-secret"></i> BLIND
                </button>
                <button class="btn-board-select" onclick="selectBoardAndWrite('jobs')">
                    <i class="fas fa-briefcase"></i> 구인구직
                </button>
            </div>
            <button class="btn-modal-close" onclick="closeBoardModal()">닫기</button>
        </div>
    </div>


    <!-- Floating Schedule Button (Left Side) -->
    <button class="floating-schedule-btn" onclick="openScheduleModal()" aria-label="스케줄러">
        <i class="fas fa-calendar-alt"></i>
    </button>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal-overlay">
        <div class="modal-content schedule-modal-content">
            <h3 class="modal-title">기능 선택</h3>

            <div class="feature-select-buttons">
                <button class="btn-feature-select active" onclick="showScheduleFeature('calendar')">
                    <i class="fas fa-calendar-alt"></i> 달력
                </button>
            </div>

            <div id="calendarFeature" class="schedule-feature-content">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="prevMonth()"><i class="fas fa-chevron-left"></i></button>
                    <span id="calendarMonthYear" class="calendar-month-year"></span>
                    <button class="calendar-nav-btn" onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-weekdays">
                    <span>일</span><span>월</span><span>화</span><span>수</span><span>목</span><span>금</span><span>토</span>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>

                <div id="scheduleForm" class="schedule-form hidden">
                    <h4 id="selectedDateTitle" class="schedule-form-title"></h4>
                    <div class="schedule-form-group"><label>촬영 시작</label><input type="time" id="filmingStartTime"
                            class="schedule-input"></div>
                    <div class="schedule-form-group"><label>촬영 종료</label><input type="time" id="filmingEndTime"
                            class="schedule-input"></div>
                    <div class="schedule-form-group"><label>프로덕션</label><input type="text" id="productionName"
                            class="schedule-input" placeholder="프로덕션 이름"></div>
                    <div class="schedule-form-group"><label>담당 PD</label><input type="text" id="pdName"
                            class="schedule-input" placeholder="PD 이름"></div>
                    <div class="schedule-form-group"><label>PD 연락처</label><input type="text" id="pdContact"
                            class="schedule-input" placeholder="010-0000-0000"></div>
                    <div class="schedule-form-group"><label>메모</label><textarea id="scheduleMemo"
                            class="schedule-textarea" placeholder="메모를 입력하세요"></textarea></div>
                    <div class="schedule-form-buttons">
                        <button class="btn btn-primary" onclick="saveSchedule()">저장</button>
                        <button class="btn btn-secondary" onclick="cancelScheduleForm()">취소</button>
                    </div>
                </div>
                <div id="scheduleList" class="schedule-list"></div>
            </div>
            <button class="btn-modal-close" onclick="closeScheduleModal()">닫기</button>
        </div>
    </div>

    <script>
        let currentCalendarDate = new Date();
        let selectedDate = null;
        let editingScheduleId = null;

        function openScheduleModal() {
            if (!currentUser) { showError('로그인이 필요한 기능입니다.'); return; }
            document.getElementById('scheduleModal').classList.add('active');
            renderCalendar();
        }
        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.remove('active');
            cancelScheduleForm();
        }
        function showScheduleFeature(feature) {
            document.querySelectorAll('.btn-feature-select').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.btn-feature-select').classList.add('active');
        }
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            document.getElementById('calendarMonthYear').textContent = `${year}년 ${month + 1}월`;
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            for (let i = 0; i < startingDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                grid.appendChild(emptyCell);
            }
            const today = new Date();
            for (let day = 1; day <= totalDays; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                const cellDate = new Date(year, month, day);
                const dateStr = cellDate.toISOString().split('T')[0];
                dayCell.dataset.date = dateStr;
                if (cellDate.toDateString() === today.toDateString()) dayCell.classList.add('today');
                if (selectedDate === dateStr) dayCell.classList.add('selected');
                dayCell.onclick = () => selectCalendarDate(dateStr, day);
                grid.appendChild(dayCell);
            }
            loadMonthSchedules(year, month + 1);
        }
        function prevMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); }
        function nextMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); }
        function selectCalendarDate(dateStr, day) {
            selectedDate = dateStr;
            document.querySelectorAll('.calendar-day').forEach(cell => {
                cell.classList.remove('selected');
                if (cell.dataset.date === dateStr) cell.classList.add('selected');
            });
            document.getElementById('scheduleForm').classList.remove('hidden');
            document.getElementById('selectedDateTitle').textContent = `${currentCalendarDate.getFullYear()}년 ${currentCalendarDate.getMonth() + 1}월 ${day}일`;
            clearScheduleForm();
            loadDateSchedules(dateStr);
        }
        function clearScheduleForm() {
            document.getElementById('filmingStartTime').value = '';
            document.getElementById('filmingEndTime').value = '';
            document.getElementById('productionName').value = '';
            document.getElementById('pdName').value = '';
            document.getElementById('pdContact').value = '';
            document.getElementById('scheduleMemo').value = '';
            editingScheduleId = null;
        }
        function cancelScheduleForm() {
            document.getElementById('scheduleForm').classList.add('hidden');
            selectedDate = null;
            editingScheduleId = null;
            renderCalendar();
        }
        async function loadMonthSchedules(year, month) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/schedules/month?year=${year}&month=${month}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.ok) {
                    const schedules = await response.json();
                    schedules.forEach(schedule => {
                        const dayCell = document.querySelector(`.calendar-day[data-date="${schedule.scheduleDate}"]`);
                        if (dayCell) dayCell.classList.add('has-schedule');
                    });
                }
            } catch (error) { console.error('Failed to load month schedules:', error); }
        }
        async function loadDateSchedules(dateStr) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/schedules/date?date=${dateStr}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.ok) { const schedules = await response.json(); renderScheduleList(schedules); }
            } catch (error) { console.error('Failed to load date schedules:', error); }
        }
        function renderScheduleList(schedules) {
            const list = document.getElementById('scheduleList');
            if (schedules.length === 0) { list.innerHTML = '<div class="no-schedules">등록된 스케줄이 없습니다</div>'; return; }
            list.innerHTML = schedules.map(schedule => `
                <div class="schedule-item" data-id="${schedule.id}">
                    <div class="schedule-item-header">
                        <span class="schedule-time">${schedule.filmingStartTime || '??:??'} - ${schedule.filmingEndTime || '??:??'}</span>
                        <div class="schedule-item-actions">
                            <button onclick="editSchedule(${schedule.id})" class="btn-icon"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteSchedule(${schedule.id})" class="btn-icon danger"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="schedule-item-details">
                        ${schedule.productionName ? `<div><strong>프로덕션:</strong> ${schedule.productionName}</div>` : ''}
                        ${schedule.pdName ? `<div><strong>담당 PD:</strong> ${schedule.pdName}</div>` : ''}
                        ${schedule.pdContact ? `<div><strong>연락처:</strong> ${schedule.pdContact}</div>` : ''}
                        ${schedule.memo ? `<div><strong>메모:</strong> ${schedule.memo}</div>` : ''}
                    </div>
                </div>`).join('');
        }
        async function saveSchedule() {
            if (!selectedDate) { showError('날짜를 선택해주세요'); return; }
            const data = {
                scheduleDate: selectedDate,
                filmingStartTime: document.getElementById('filmingStartTime').value || null,
                filmingEndTime: document.getElementById('filmingEndTime').value || null,
                productionName: document.getElementById('productionName').value || null,
                pdName: document.getElementById('pdName').value || null,
                pdContact: document.getElementById('pdContact').value || null,
                memo: document.getElementById('scheduleMemo').value || null
            };
            try {
                const token = localStorage.getItem('token');
                const url = editingScheduleId ? `/api/schedules/${editingScheduleId}` : '/api/schedules';
                const method = editingScheduleId ? 'PUT' : 'POST';
                const response = await fetch(url, { method, headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (response.ok) { showSuccess(editingScheduleId ? '스케줄이 수정되었습니다' : '스케줄이 저장되었습니다'); clearScheduleForm(); loadDateSchedules(selectedDate); renderCalendar(); }
                else { throw new Error('Save failed'); }
            } catch (error) { showError('스케줄 저장에 실패했습니다'); }
        }
        async function editSchedule(id) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/schedules/date?date=${selectedDate}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.ok) {
                    const schedules = await response.json();
                    const schedule = schedules.find(s => s.id === id);
                    if (schedule) {
                        document.getElementById('filmingStartTime').value = schedule.filmingStartTime || '';
                        document.getElementById('filmingEndTime').value = schedule.filmingEndTime || '';
                        document.getElementById('productionName').value = schedule.productionName || '';
                        document.getElementById('pdName').value = schedule.pdName || '';
                        document.getElementById('pdContact').value = schedule.pdContact || '';
                        document.getElementById('scheduleMemo').value = schedule.memo || '';
                        editingScheduleId = id;
                    }
                }
            } catch (error) { showError('스케줄을 불러오는데 실패했습니다'); }
        }
        async function deleteSchedule(id) {
            if (!confirm('이 스케줄을 삭제하시겠습니까?')) return;
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/schedules/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                if (response.ok) { showSuccess('스케줄이 삭제되었습니다'); loadDateSchedules(selectedDate); renderCalendar(); }
                else { throw new Error('Delete failed'); }
            } catch (error) { showError('스케줄 삭제에 실패했습니다'); }
        }
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('scheduleModal').addEventListener('click', (e) => { if (e.target.id === 'scheduleModal') closeScheduleModal(); });
        });
    </script>

</html>