<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFF THE RECORD</title>
    <link rel="stylesheet" href="/css/style.css?v=7">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                OFF THE RECORD
            </a>
            <div class="nav">
                <span id="userInfo" class="user-info"></span>
                <button id="loginBtn" class="btn-cool btn-cool-compact hidden" onclick="location.href='/login.html'"
                    aria-label="ë¡œê·¸ì¸">
                    <i class="fas fa-sign-in-alt"></i> LOGIN
                </button>
                <button id="logoutBtn" class="btn btn-secondary btn-compact hidden" aria-label="ë¡œê·¸ì•„ì›ƒ">
                    <i class="fas fa-lock-open"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Board Tabs -->
        <div class="board-tabs">
            <button class="board-tab active" onclick="switchBoard('free')">ììœ ê²Œì‹œíŒ</button>
            <button class="board-tab" onclick="switchBoard('anonymous')">ìµëª…ê²Œì‹œíŒ</button>
            <button class="board-tab" onclick="switchBoard('jobs')">êµ¬ì¸êµ¬ì§</button>
        </div>

        <div id="postsContainer" class="mobile-post-list">
            <div class="loading">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <div id="emptyState" class="empty-state hidden">
            <h2>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h2>
            <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ë³´ì„¸ìš”</p>
        </div>

        <div id="pagination" class="pagination hidden"></div>

        <!-- ê²€ìƒ‰ í† ê¸€ ë²„íŠ¼ (í•˜ë‹¨ ê³ ì •) -->
        <button id="searchToggleBtn" class="search-toggle-btn" aria-label="ê²€ìƒ‰">
            ğŸ”
        </button>

        <!-- ê²€ìƒ‰ ì˜ì—­ (ê¸°ë³¸ ìˆ¨ê¹€) -->
        <div id="searchContainer" class="search-container-bottom hidden">
            <div class="search-header">
                <h3>ê²€ìƒ‰</h3>
                <button id="closeSearchBtn" class="close-search-btn">âœ•</button>
            </div>
            <select id="searchType" class="search-select">
                <option value="title_content">ì œëª©+ë‚´ìš©</option>
                <option value="title">ì œëª©</option>
                <option value="content">ë‚´ìš©</option>
                <option value="author">ì‘ì„±ì</option>
            </select>
            <input type="text" id="searchKeyword" class="search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
            <div class="search-buttons">
                <button id="searchBtn" class="btn btn-primary">ê²€ìƒ‰</button>
                <button id="resetBtn" class="btn btn-secondary">ì „ì²´ë³´ê¸°</button>
            </div>
        </div>
    </div>
    </div>
    </div>

    <!-- Floating Write Button -->
    <button class="floating-write-btn" onclick="goToWritePage()" aria-label="ê¸€ì“°ê¸°">
        <i class="fas fa-pen"></i>
    </button>

    <script src="/js/app.js"></script>
    <script>
        let currentUser = null;
        let currentPage = 0;
        let currentBoardId = 'free';
        let currentSearchType = '';
        let currentKeyword = '';
        const pageSize = 15;

        async function init() {
            // Check authentication
            currentUser = await getCurrentUser();

            const userInfo = document.getElementById('userInfo');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            if (currentUser) {
                // Logged in
                if (currentUser.role === 'ADMIN') {
                    userInfo.innerHTML = `<span class="admin-nickname-container"><i class="fas fa-camera"></i> ${escapeHtml(currentUser.nickname)}</span>`;
                } else {
                    userInfo.textContent = currentUser.nickname;
                }
                logoutBtn.classList.remove('hidden');
                loginBtn.classList.add('hidden');
            } else {
                // Guest
                userInfo.textContent = '';
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }

            // Load posts
            await loadPosts(0);

            // Setup search toggle
            document.getElementById('searchToggleBtn').addEventListener('click', toggleSearch);
            document.getElementById('closeSearchBtn').addEventListener('click', closeSearch);

            // Setup search
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('searchKeyword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            document.getElementById('resetBtn').addEventListener('click', resetSearch);
        }

        function toggleSearch() {
            const searchContainer = document.getElementById('searchContainer');
            const toggleBtn = document.getElementById('searchToggleBtn');

            if (searchContainer.classList.contains('hidden')) {
                searchContainer.classList.remove('hidden');
                toggleBtn.classList.add('active');
            } else {
                searchContainer.classList.add('hidden');
                toggleBtn.classList.remove('active');
            }
        }

        function closeSearch() {
            document.getElementById('searchContainer').classList.add('hidden');
            document.getElementById('searchToggleBtn').classList.remove('active');
        }

        async function switchBoard(boardId) {
            currentBoardId = boardId;
            currentKeyword = '';
            currentSearchType = '';
            document.getElementById('searchKeyword').value = '';

            // Update UI
            document.querySelectorAll('.board-tab').forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('onclick').includes(`'${boardId}'`));
            });

            await loadPosts(0);
        }

        async function performSearch() {
            const searchType = document.getElementById('searchType').value;
            const keyword = document.getElementById('searchKeyword').value.trim();

            if (!keyword) {
                showError('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            currentSearchType = searchType;
            currentKeyword = keyword;
            closeSearch();
            await loadPosts(0);
        }

        async function resetSearch() {
            currentSearchType = '';
            currentKeyword = '';
            document.getElementById('searchKeyword').value = '';
            document.getElementById('searchType').value = 'title_content';
            closeSearch();
            await loadPosts(0);
        }

        async function loadPosts(page) {
            const container = document.getElementById('postsContainer');
            const emptyState = document.getElementById('emptyState');
            const pagination = document.getElementById('pagination');

            try {
                let url;
                if (currentKeyword) {
                    url = `/api/posts/search?boardId=${currentBoardId}&searchType=${currentSearchType}&keyword=${encodeURIComponent(currentKeyword)}&page=${page}&size=${pageSize}`;
                } else {
                    url = `/api/posts?boardId=${currentBoardId}&page=${page}&size=${pageSize}`;
                }

                const response = await fetch(url, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.posts.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    pagination.classList.add('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                currentPage = data.currentPage;

                // Render posts as mobile cards
                container.innerHTML = data.posts.map(post => createMobilePostCard(post)).join('');

                // Render pagination
                renderPagination(data.currentPage, data.totalPages);
            } catch (error) {
                console.error('Error loading posts:', error);
                showError('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        function createMobilePostCard(post) {
            const date = new Date(post.createdAt);
            const timeString = formatTimeAgo(date); // Use time ago for list view

            // Thumbnail Logic: Use image if exists, otherwise "No Image" text
            let thumbnailHtml;
            if (post.imageUrl) {
                thumbnailHtml = `<img src="${post.imageUrl}" alt="thumbnail" loading="lazy">`;
            } else {
                thumbnailHtml = `<div class="post-thumbnail-placeholder"><span>No</span><span>Image</span></div>`;
            }

            return `
                <div class="mobile-post-card" onclick="location.href='/post-detail.html?id=${post.id}'">
                    <div class="post-thumbnail-area">
                        ${thumbnailHtml}
                    </div>
                    
                    <div class="post-content-area">
                        <div class="mobile-post-header">
                            <h3 class="mobile-post-title">
                                ${isNewPost(date) ? '<span class="new-badge"></span>' : ''}
                                ${post.title}
                            </h3>
                        </div>
                        
                        <div class="mobile-post-footer">
                            <div class="post-meta-left">
                                ${post.authorRole === 'ADMIN' ?
                    `<span class="admin-nickname-container"><i class="fas fa-camera"></i> ${escapeHtml(post.authorNickname)}</span>` :
                    `<span class="user-nickname-badge"><i class="fas fa-user"></i> ${escapeHtml(post.authorNickname || 'ìµëª…')}</span>`
                }
                                <span>${timeString}</span>
                            </div>
                            <div class="post-meta-right">
                                <span><i class="fas fa-eye"></i> ${formatNumber(post.viewCount || 0)}</span>
                                <span><i class="fas fa-comment-dots"></i> ${formatNumber(post.commentCount || 0)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.classList.add('hidden');
                return;
            }

            pagination.classList.remove('hidden');

            const maxButtons = 5;
            let startPage = Math.max(0, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages - 1, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(0, endPage - maxButtons + 1);
            }

            let html = '';

            // Previous button
            if (currentPage > 0) {
                html += `<button class="page-btn" onclick="loadPosts(${currentPage - 1})">ì´ì „</button>`;
            }

            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentPage ? 'active' : '';
                html += `<button class="page-btn ${active}" onclick="loadPosts(${i})">${i + 1}</button>`;
            }

            // Next button
            if (currentPage < totalPages - 1) {
                html += `<button class="page-btn" onclick="loadPosts(${currentPage + 1})">ë‹¤ìŒ</button>`;
            }

            pagination.innerHTML = html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }


        function goToWritePage() {
            window.location.href = `/post-form.html?boardId=${currentBoardId}`;
        }

        document.getElementById('logoutBtn').addEventListener('click', logout);
        init();
    </script>
</body>

</html>