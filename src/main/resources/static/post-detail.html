<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ìƒì„¸ - OFF THE RECORD</title>
    <link rel="stylesheet" href="/css/style.css?v=5">
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <img src="/images/logo.png" alt="OFF THE RECORD" class="logo-icon">
                OFF THE RECORD
            </a>
            <nav class="nav">
                <a href="/" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="post-detail">
            <div id="postContent">
                <div class="loading">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <div id="postActions" class="post-actions hidden">
                <button id="editBtn" class="btn btn-primary">ìˆ˜ì •</button>
                <button id="deleteBtn" class="btn btn-danger">ì‚­ì œ</button>
            </div>

            <div class="comments-section">
                <h2 class="comments-title">ëŒ“ê¸€ <span id="commentCount">0</span></h2>

                <form id="commentForm" class="hidden">
                    <div class="form-group">
                        <textarea id="commentContent" class="form-textarea" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">ëŒ“ê¸€ ì‘ì„±</button>
                </form>

                <div id="commentsContainer" class="mt-lg">
                    <div class="loading">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        let currentUser = null;
        let currentPost = null;

        async function init() {
            if (!postId) {
                window.location.href = '/';
                return;
            }

            // Check authentication
            currentUser = await getCurrentUser();
            if (!currentUser) {
                window.location.href = '/login.html';
                return;
            }

            // Load post and comments
            await loadPost();
            await loadComments();

            // Show comment form
            document.getElementById('commentForm').classList.remove('hidden');
        }

        async function loadPost() {
            const post = await getPost(postId);
            if (!post) {
                showError('ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                window.location.href = '/';
                return;
            }

            currentPost = post;
            const emoji = getRandomEmoji();
            const authorName = post.authorNickname || post.authorUsername || 'ìµëª…';

            document.getElementById('postContent').innerHTML = `
                <div class="post-detail-header">
                    <div class="avatar">${emoji}</div>
                    <div class="card-author">
                        <div class="author-name">${escapeHtml(authorName)}</div>
                        <div class="post-date">${formatDate(post.createdAt)}</div>
                    </div>
                </div>
                <h1 class="post-detail-title">${escapeHtml(post.title)}</h1>
                ${post.imageUrl ? `<div class="post-detail-image"><img src="${post.imageUrl}" alt="Post Image"></div>` : ''}
                <div class="post-detail-content">${escapeHtml(post.content)}</div>
                <div class="card-footer">
                    <span>ğŸ‘ï¸ ì¡°íšŒìˆ˜ ${post.viewCount}</span>
                    <span>ğŸ’¬ ëŒ“ê¸€ ${post.commentCount}</span>
                </div>
            `;

            // Show action buttons only if current user is the author
            if (currentUser && post.authorUsername === currentUser.username) {
                document.getElementById('postActions').classList.remove('hidden');
            }
        }

        async function loadComments() {
            const comments = await getComments(postId);
            const container = document.getElementById('commentsContainer');
            document.getElementById('commentCount').textContent = comments.length;

            if (comments.length === 0) {
                container.innerHTML = '<div class="empty-state">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = comments.map(comment => {
                const emoji = getRandomEmoji();
                return `
                    <div class="comment">
                        <div class="comment-header">
                            <div class="avatar">${emoji}</div>
                            <div class="card-author">
                                <div class="author-name">ìµëª…</div>
                                <div class="post-date">${formatDate(comment.createdAt)}</div>
                            </div>
                        </div>
                        <div class="comment-content">${escapeHtml(comment.content)}</div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('commentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const content = document.getElementById('commentContent').value;

            try {
                await createComment(postId, content);
                document.getElementById('commentContent').value = '';
                await loadComments();
                showSuccess('ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
            } catch (error) {
                showError('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        });

        document.getElementById('editBtn').addEventListener('click', () => {
            window.location.href = `/post-form.html?id=${postId}`;
        });

        document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const success = await deletePost(postId);
                if (success) {
                    showSuccess('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    window.location.href = '/';
                } else {
                    showError('ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            }
        });

        init();
    </script>
</body>

</html>