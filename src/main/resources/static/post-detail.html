<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 상세 - OFF THE RECORD</title>
    <link rel="stylesheet" href="/css/style.css?v=7">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <img src="/images/logo.png" alt="OFF THE RECORD" class="logo-icon">
                OFF THE RECORD
            </a>
            <nav class="nav">
                <a href="/" class="btn btn-secondary">목록으로</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="post-detail">
            <div id="postContent">
                <div class="loading">게시글을 불러오는 중...</div>
            </div>

            <div id="postActions" class="post-actions hidden">
                <button id="editBtn" class="btn btn-primary">수정</button>
                <button id="deleteBtn" class="btn btn-danger">삭제</button>
            </div>

            <div class="comments-section">
                <h2 class="comments-title">댓글 <span id="commentCount">0</span></h2>

                <form id="commentForm" class="hidden">
                    <div class="form-group">
                        <textarea id="commentContent" class="form-textarea" placeholder="댓글을 입력하세요" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">댓글 작성</button>
                </form>

                <div id="commentsContainer" class="mt-lg">
                    <div class="loading">댓글을 불러오는 중...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="lightbox" class="lightbox-modal">
        <button id="lightboxClose" class="lightbox-close">&times;</button>
        <img id="lightboxImage" class="lightbox-content" src="" alt="Enlarged Image">
    </div>

    <script src="/js/app.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('id');
        let currentUser = null;
        let currentPost = null;

        async function init() {
            if (!postId) {
                window.location.href = '/';
                return;
            }

            // Check authentication
            currentUser = await getCurrentUser();
            if (!currentUser) {
                window.location.href = '/login.html';
                return;
            }

            // Load post and comments
            await loadPost();
            await loadComments();

            // Show comment form
            document.getElementById('commentForm').classList.remove('hidden');

            setupLightbox();
        }

        async function loadPost() {
            const post = await getPost(postId);
            if (!post) {
                showError('게시글을 찾을 수 없습니다');
                window.location.href = '/';
                return;
            }

            currentPost = post;
            const emoji = getRandomEmoji();
            const authorName = post.authorNickname || post.authorUsername || '익명';

            document.getElementById('postContent').innerHTML = `
                <div class="post-detail-header">
                    <div class="avatar">${emoji}</div>
                    <div class="card-author">
                        <div class="author-name">${escapeHtml(authorName)}</div>
                        <div class="post-date">${formatDate(post.createdAt)}</div>
                    </div>
                </div>
                <h1 class="post-detail-title">${escapeHtml(post.title)}</h1>
                <div class="post-detail-images">
                    ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image 1" onclick="openLightbox('${post.imageUrl}')">` : ''}
                    ${post.imageUrl2 ? `<img src="${post.imageUrl2}" alt="Post Image 2" onclick="openLightbox('${post.imageUrl2}')">` : ''}
                    ${post.imageUrl3 ? `<img src="${post.imageUrl3}" alt="Post Image 3" onclick="openLightbox('${post.imageUrl3}')">` : ''}
                </div>
                <div class="post-detail-content">${escapeHtml(post.content)}</div>
                <div class="card-footer">
                    <span><i class="fas fa-eye"></i> ${formatNumber(post.viewCount)}</span>
                    <span><i class="fas fa-comment-dots"></i> ${formatNumber(post.commentCount)}</span>
                </div>
            `;

            // Show action buttons only if current user is the author
            // Show action buttons only if current user is the author or an admin
            if (currentUser && (post.authorUsername === currentUser.username || currentUser.role === 'ADMIN')) {
                document.getElementById('postActions').classList.remove('hidden');

                // If admin but NOT author, hide edit button (only allow delete)
                if (currentUser.role === 'ADMIN' && post.authorUsername !== currentUser.username) {
                    document.getElementById('editBtn').classList.add('hidden');
                }
            }
        }

        async function loadComments() {
            const comments = await getComments(postId);
            const container = document.getElementById('commentsContainer');
            document.getElementById('commentCount').textContent = comments.length;

            if (comments.length === 0) {
                container.innerHTML = '<div class="empty-state">아직 댓글이 없습니다</div>';
                return;
            }

            container.innerHTML = comments.map(comment => {
                const emoji = getRandomEmoji();
                const isAdmin = currentUser && currentUser.role === 'ADMIN';
                const isAuthor = currentUser && comment.authorUsername === currentUser.username;
                const canDelete = isAuthor || isAdmin;

                return `
                    <div class="comment">
                        <div class="comment-header">
                            <div class="comment-author-info">
                                <div class="avatar">${emoji}</div>
                                <div class="card-author">
                                    <div class="author-name">${escapeHtml(comment.authorNickname || '익명')}</div>
                                    <div class="post-date">${formatDate(comment.createdAt)}</div>
                                </div>
                            </div>
                            ${canDelete ? `
                                <button type="button" class="btn-delete-comment" onclick="handleDeleteComment(${comment.id})">
                                    <i class="fas fa-trash-alt"></i> 삭제
                                </button>
                            ` : ''}
                        </div>
                        <div class="comment-content">${escapeHtml(comment.content)}</div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('commentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const content = document.getElementById('commentContent').value;

            try {
                await createComment(postId, content);
                document.getElementById('commentContent').value = '';
                await loadComments();
                showSuccess('댓글이 작성되었습니다');
            } catch (error) {
                showError('댓글 작성에 실패했습니다');
            }
        });

        document.getElementById('editBtn').addEventListener('click', () => {
            window.location.href = `/post-form.html?id=${postId}`;
        });

        document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (confirm('정말 삭제하시겠습니까?')) {
                const success = await deletePost(postId);
                if (success) {
                    showSuccess('게시글이 삭제되었습니다');
                    window.location.href = '/';
                } else {
                    showError('게시글 삭제에 실패했습니다');
                }
            }
        });

        async function handleDeleteComment(commentId) {
            if (confirm('댓글을 삭제하시겠습니까?')) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`/api/comments/${commentId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        showSuccess('댓글이 삭제되었습니다');
                        await loadComments();
                    } else {
                        throw new Error('Delete failed');
                    }
                } catch (error) {
                    showError('댓글 삭제에 실패했습니다');
                }
            }
        }

        // Expose handleDeleteComment to global scope for onclick
        window.handleDeleteComment = handleDeleteComment;

        // Lightbox Functions
        function setupLightbox() {
            const lightbox = document.getElementById('lightbox');
            const closeBtn = document.getElementById('lightboxClose');

            closeBtn.addEventListener('click', closeLightbox);
            lightbox.addEventListener('click', (e) => {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });

            // Escape key to close
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && lightbox.classList.contains('active')) {
                    closeLightbox();
                }
            });
        }

        function openLightbox(imageUrl) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightboxImage');

            lightboxImage.src = imageUrl;
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Expose openLightbox to global scope for inline onclick
        window.openLightbox = openLightbox;

        init();
    </script>
</body>

</html>